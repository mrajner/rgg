%% this package is extension to rgg.cls
%% to combine several papers
%%
%% it defines 3 command
%%
%% \makecolophon
%% \includerggtex
%% \includerggpdf
%%
%% Marcin Rajner
%% 2016.04.23

% \PassOptionsToClass{draft}{article}
\newcounter{inclusion}
\setcounter{inclusion}{0}

\RequirePackage{tocloft}
\tocloftpagestyle{empty}
\newcommand{\listpapers}{\Large Contents}
\newlistof{papers}{pap}{\listpapers}

\renewcommand{\cftpapersleader}{ }

\setlength{\cftbeforepapersskip}{1.6em}

\usepackage{etoolbox}
\RequirePackage{emptypage}
\RequirePackage{standalone}
\RequirePackage{pdfpages}

\RequirePackage{xparse}

\let\titleold=\title
\let\authorold=\author

\renewcommand{\title}[2][\empty]{
  \ifx#1\empty
  \titleold{#2}
  \else
  \titleold[#1]{#2}
  \fi
  \def\thetitle{#2}
}
\renewcommand{\author}[2][\empty]{
  \ifx#1\empty
  \authorold{#2}
  \else
  \authorold[#1]{#2}
  \fi
  \def\theauthor{#2}
}

\def\addtopapers{%
  \addcontentsline{pap}{papers}{
    \hyphenpenalty=10000
    \parbox[t]{0.8\linewidth}{
      {\bfseries\thetitle}
      \newline
      \em\theauthor 
    }
  }
}

\let\maketitleold=\maketitle
\renewcommand{\maketitle}{
  \maketitleold
  \addtopapers
}

\NewDocumentCommand{\includergg}{O{} m O{tex} } {%

  \setcounter{figure}{0}
  \setcounter{section}{0}
  \addtocounter{inclusion}{1}
  \xdef\firstpage{\thepage}
  \def\lastpage{\pageref{LastPage\theinclusion}}
  \begin{refsection}[#2]
    \ifstrequal{#3}{pdf}{
      \addtopapers
      \includepdf[#1,pages=1,pagecommand={}]{#2}
      \includepdf[#1,pages=2-,pagecommand={}]{#2}
    }{%
      \input{#2}
    }
    \label{LastPage\theinclusion}
  \end{refsection}
  \cleardoublepage
}

\def\makecolophon{%
  \clearpage
  \thispagestyle{empty}
  \null\vfill
  \noindent
  \textbf{\rgg}\\
  volume \rgg@volume, number \rgg@number, \rgg@year\\
  \\
  \textbf{Editor-in-Chief}\\
  Marcin Barlik\\
  \\
  \textbf{Managing Editor}\\
  Ryszard Szpunar\\
  \\
  \textbf{Editorial Board}\\
  Jerzy Chmiel\\
  Paweł Kowalski\\
  Grzegorz Lenda\\
  Tomasz Liwosz\\
  Tomasz Olszak\\
  Paweł Pędzich\\
  Dorota Zawieska\\
  \\
  \textbf{Technical Editor}\\
  Dominik Próchniewicz\\
  \\
  \url{http://www.reports.gik.pw.edu.pl}\\
  \href{mailto:reports.geodesy@gmail.com}
  {\texttt{reports.geodesy@gmail.com}}\\
  \\
  \textbf{Publisher}\\
  DE GRUYTER OPEN\\
  Bogumiła Zuga 32A Str.\\
  01-811 Warsaw, Poland\\
  \\
  ISSN \rgg@ISSN
  \clearpage%
}

\newcommand{\bibtextobiblatex}{
  \let\oldcite=\cite
  \let\citeNP=\oldcite
  \let\cite=\parencite
  % \renewcomand{\bibliography}[1]{\relax}
  % \let\bibliography=\addsectionbib
  \renewcommand{\bibliography}[1]{
    \printbibliography
  }
}

% \let\olddoi=\doi
% \renewcommand{\doi}[1]{%
    % \def\rgg@doi{\olddoi{#1}}
% }
