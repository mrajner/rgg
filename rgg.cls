%% This file is LaTeX class for submission
%% to Reports on Geodesy and Geoinformatics
%%
%% this class follows author guidelines specified at
%% http://www.reports.gik.pw.edu.pl
%% and mimic the official Word template

%% DO NOT edit this file directly
%% put all your additional settings
%% inside your .tex file(s) submitted to editors.

%% If you believe that there is a bug in this class
%% or you encountered any incompatibilities
%% or other technical issues
%% or you need any fancy setting which cannot be achieved
%% without touching this class file
%% please contact mrajner@gik.pw.edu.pl
%% created 20151116 Marcin Rajner

\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{rgg}[2015/11/16]

%% use standard article rules by default
%% with 12 point font size
\LoadClass[12pt,twoside]{article}

%% English language rules for all document
\RequirePackage[english]{babel}

%% process class options
\RequirePackage{kvoptions}
\SetupKeyvalOptions{
   family=rgg,
   prefix=rgg@,
}
\DeclareStringOption[1]{startpage}
\DeclareStringOption[]{volume}
\DeclareStringOption[]{doi}
\DeclareStringOption[year]{year}
\DeclareBoolOption{review}
\ProcessKeyvalOptions*

\setcounter{page}{\rgg@startpage}

\ifrgg@review
\RequirePackage{lineno}
\linenumbers
\linespread{2}
\fi

%% use a4 paper size with all margins set to 2.5 cm
\RequirePackage
[
  a4paper,
  margin = 2.5cm,
  % includehead,
  headheight=0cm,
]
{geometry}

%% font selection according to engine used in compilation
\RequirePackage{ifxetex,ifluatex}
\newif\ifxetexorluatex
\ifxetex
  \xetexorluatextrue
\else
  \ifluatex
    \xetexorluatextrue
  \else
    \xetexorluatexfalse
  \fi
\fi

\ifxetexorluatex
  %% if you compile document using xelatex or lualatex you can
  %% directly access system fonts
  %% while Arial is not free font and could not be installed
  %% on every machine you can use linux substitute named
  %% Liberation Sans
  %% if you have Arial installed you can uncomment
  %% line \setmainfont{Arial}
  \RequirePackage{fontspec}
  \setmainfont{Liberation Sans}
  % \setmainfont{Arial}
\else
  %% Unicode support for (pdf)latex
  \RequirePackage[utf8]{inputenc}
  \RequirePackage[scaled]{helvet}
\fi

%% use sans-serif font for whole document
\renewcommand{\familydefault}{\sfdefault}
\RequirePackage{sansmath}\sansmath

%% maketitle command style
\renewcommand\maketitle{
  %% title bold and centred and all in upper case
  % \thispagestyle{plain}
  \par
  \vskip6em
  \parbox{14cm}{
    \begin{center}
      {\bfseries\large\MakeUppercase{\@title}\par}
    \end{center}
  }
  % \vspace*{0.6cm}
  \begin{center}
    {\bfseries\@author}\\
    \vspace*{0.5em}
    {\@affiliation}
  \end{center}
  % \vspace*{1.1 cm}
  % \vskip 30\p@ \@plus 10\p@ \@minus 2\p@
  % }
\suppressfloats
}

%% float environments
\RequirePackage{floatrow}
\floatsetup[table]{
  capposition=top,
}

\RequirePackage{caption}
\captionsetup
{
  labelsep=period,
  labelfont={bf,small},
}
\captionsetup[figure]{
  name=Fig.,
}
\captionsetup[table]{
  name=Tab.,
}

\RequirePackage{booktabs}

%% affiliation environment
\newcommand\affiliation[1]{\gdef\@affiliation{#1}}
\gdef\@affiliation{}
\newcommand{\nextaffiliation}{\leavevmode\vskip0.5em}

%% author and short version of atuhor to running header
\renewcommand\author{\@ifnextchar [{\@authortwo}{\@authorone}}%}
\def\@authortwo[#1]#2{\gdef\@author{#2}\gdef\@shortauthor{#1}}
\def\@authorone#1{\gdef\@author{#1}%}
\begingroup\def\and{and}\gdef\@shortauthor{#1}\endgroup}
\gdef\@author{\mbox{}}

%% same for title
\renewcommand\title{\@ifnextchar [{\@titletwo}{\@titleone}}%}
\def\@titletwo[#1]#2{\gdef\@title{#2}\gdef\@shorttitle{#1}}
\def\@titleone#1{\gdef\@title{#1}%}
\begingroup\def\and{and}\gdef\@shorttitle{#1}\endgroup}
\gdef\@title{\mbox{}}

% redefinition of section and subsection environment
\renewcommand{\@seccntformat}[1]{\csname the#1\endcsname.\quad}
\renewcommand\section{%
    \@startsection {section}{1}{\z@}%
    {-1em \@plus -1ex \@minus -.2ex}%
    {0.5em \@plus.2ex}%
    {\normalfont\bfseries}%
  }
\renewcommand\subsection{\@startsection {subsection}{1}{\z@}%
    {-0.6em \@plus -1ex \@minus -.2ex}%
    {0.3em \@plus.2ex}%
    {\normalfont\bfseries}%
  }%}

%% apply ``better'' microtypography
\RequirePackage{microtype}

%% enhance math mode
\RequirePackage{amsmath}
\RequirePackage{amssymb}

%% Use the APA format as a style of citation and reference list (see Guidelines for APA Citation Style with examples)
\bibliographystyle{apacite}

%% include graphics
\RequirePackage{graphicx}

%% abstract and keywords

\newcommand\keywords[1]{\long\gdef\@keywords{#1}}
\gdef\@keywords{}
\renewenvironment{abstract}
{
  \setlength{\leftmargin}{5em}%
    \list{}{\setlength{\rightmargin}{\leftmargin}}%
  \item\relax{\bfseries \abstractname}\newline
    \itshape
  }{\upshape\newline\vskip-0.5em
    \textbf{Keywords:}
    \@keywords
    \vspace{0.6em}
  \endlist}

\RequirePackage{lastpage}
\RequirePackage{fancyhdr}
\pagestyle{fancy}
\fancyhead{}
\fancyfoot{}
\fancyfoot[C]{\small\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

\def\headerfirstpage{%
  \textit{Reports on Geodesy and Geoinformatics}
  vol.\,\rgg@volume/\rgg@year; pages \rgg@startpage-\pageref{LastPage}%
}
\def\doiheader{\textsc{doi:}\rgg@doi}

%% acknowledgement
\newcommand\acknowledgement[1]{%
\section*{Acknowledgement}
  {\small#1}%
}

%% email
\RequirePackage[hidelinks]{hyperref}
\newcommand\email[1]{\href{mailto:#1}{\texttt{#1}}}
\RequirePackage{array}

%% authornote
\newcommand{\authornote}[1]{%
  \vskip2em
  \noindent\rule{0.5\textwidth}{0.4pt}\\
  \let\\\newline
  \begin{tabular}
    {@{}p{0.1\textwidth}@{\hskip1em}p{0.9\textwidth}@{}}
    \textbf{Authors:} 
    & \let\\\newline #1
  \end{tabular}
}

%%%%%%%%%% TODO: DISCUSS WITH EDITORS %%%%%%%%%%%%%%%%
% \RequirePackage{changepage}
% \strictpagecheck
% \checkoddpage
% \ifoddpage

%% add logo to title page
\AtBeginDocument{%
  \thispagestyle{plain}%
  \noindent\parbox[t]{\textwidth}{%
    \IfFileExists{logo_dg.png}{%
      \includegraphics[height=1.3cm]{logo_dg}}
    {\vskip1.3cm}
  }
  \par
  \kern 2pt
  \hbox to \textwidth{\headerfirstpage\hfill\doiheader}
  \kern 2pt
  \hrule height 0.4pt
}

\fancyhead[LO]{\small\headerfirstpage}
\fancyhead[RO]{\small\doiheader}
\fancyhead[LE]{\textit{\small\@shortauthor:\ \@shorttitle}}
\fancyhead[RE]{}

\fancypagestyle{plain}{%
  \renewcommand{\headrulewidth}{0pt}
  \fancyhead{}
}

% \else
  % \fancyhead[LO]{\headerfirstpage}
  % \fancyhead[RO]{\doiheader}
  % \fi

%% Bibliography
%% clickable doi
\RequirePackage{doi}\renewcommand{\doitext}{}

%% force using apa style for bibliography
\RequirePackage[apaciteclassic]{apacite}

%% but use rgg appropriate bibitem spacing
\setlength{\bibitemsep}{\baselineskip}

\endinput
